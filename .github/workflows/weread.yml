name: weread sync

on:
  workflow_dispatch:
  schedule:
    - cron: "0 0 * * *"
jobs:
  sync:
    name: Sync
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: 3.9
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
      - name: Probe WeRead auth (notebooks)
        env:
          WEREAD_COOKIE: ${{ secrets.WEREAD_COOKIE }}
        run: |
          python - <<'PY'
          import os, requests
          c = os.environ.get("WEREAD_COOKIE","")
          print("cookie_len:", len(c))
          s = requests.Session()
          s.headers.update({
            "Cookie": c,
            "User-Agent": "Mozilla/5.0",
            "Accept": "application/json, text/plain, */*",
            "Referer": "https://weread.qq.com/",
            "Origin": "https://weread.qq.com",
          })
          r = s.get("https://i.weread.qq.com/user/notebooks", timeout=30)
          print("status:", r.status_code)
          print("body_head:", r.text[:120])
          PY

      - name: Check cookie keys (safe)
        env:
          WEREAD_COOKIE: ${{ secrets.WEREAD_COOKIE }}
        run: |
          python - <<'PY'
          import os, re, hashlib
          c = os.environ.get("WEREAD_COOKIE","")
          print("cookie_len:", len(c))
          # Safe fingerprints (won't reveal cookie)
          print("sha256:", hashlib.sha256(c.encode()).hexdigest()[:16])
          # Presence checks
          for k in ["wr_skey=", "wr_vid=", "wr_rt=", "_qimei_fingerprint=", "qq_domain_video_guid_verify="]:
            print(k, "YES" if k in c else "NO")
          # Also show how many semicolons (rough completeness indicator)
          print("semicolon_count:", c.count(";"))
          PY

      - name: weread sync
        env:
          WEREAD_COOKIE: ${{ secrets.WEREAD_COOKIE }}
          READWISE_TOKEN: ${{ secrets.READWISE_TOKEN }}
        run: |
          python weread.py

